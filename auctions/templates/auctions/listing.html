{% extends 'auctions/layout.html' %}

{% block body %}
{% if message %}
    <p>{{ message }}</p>
{% endif %}
<main>
    <section> <!-- Display information -->
        <div>
            <img src="{{ listing.image }}" alt="Listing picture" style="width:300px">
        </div>
        <div>
            {% if is_owner %}

                <strong>Your listing</strong>
                <form action="{% url 'listing_edit' listing.id %}" method="GET">
                    {% csrf_token %}
                    <input type="submit" value="Edit">
                </form>
                <br>
                {% endif %}

                {{ listing.title }}
                <br>
                {{ listing.description }}

                {% if listing.active_status == "active" %}
                <p>Status: Active</p>
                {% elif listing.active_status == "inactive" %}
                <p>Status: Inactive</p>
                {% else %}
                <p>Status: Closed</p>
                <p>Winner: {{ listing.winner }}</p>

            {% endif %}

            <p>Category: {{ category }}</p>

        </div>
        <hr>
    </section>
    <section>
        <div>

            {% if request.user.id == listing.winner.id %}
                <strong>You have won the auction!</strong><br>
            {% endif %}

            <!-- Display price -->
            {% if not listing.bids.count == 0 %} 
            <div>
                <h6>Current price:</h6>
                <h4><strong>US ${{ current_price }}</strong></h4>
            </div>
            {% else %}
            <div>
                <h6>Start bid:</h6>
                <h4><strong>US ${{ current_price }} </strong></h4>
            </div>
            {% endif %}

            <!-- Display the ammout of bids -->
            <div> 
                <a href="{% url 'bids' listing.id %}">
                    {{ listing.bids.count }}
                    {% if listing.bids.count == 1 %} 
                        bid
                    {% else %}
                        bids
                    {% endif %}
                </a>
            </div>

        </div>
        {% if not is_owner %} <!-- If user is not owner -->
            <div>

                <!-- Input bid -->
                {% if not listing.active_status == "closed" %}
                    <form action="{% url 'bid' listing.id %}", method="POST">
                        {% csrf_token %}
                        <input name="bid" type="number" step= 0.01 placeholder="Bid">
                        <input type="submit" value="Place bid">
                    </form>
                {% endif %}

                <!-- Add to the watchlist -->
                {% if not is_watching %}
                    <form action="{% url 'watchlist' listing.id %}" method="POST">
                        {% csrf_token %}
                        <input type="submit" value="Add to watchlist">
                    </form>
                {% else %}
                    <form action="{% url 'delete_watchlist' listing.id %}" method="POST">
                        {% csrf_token %}
                        <input type="submit" value="Unwatch">
                    </form>
                {% endif %}

            </div>
        {% else %} <!-- If user is owner -->
            {% if not listing.active_status == "closed" %}
                <form action="{% url 'status' listing.id %}" method="POST">
                    {% csrf_token %}
                    <input type="submit" value="Change status">
                </form>
                <form action="{% url 'close_auction' listing.id %}" method="POST">
                    {% csrf_token %}
                    <input type="submit" value="Close auction">
                </form>
            {% endif %}
        {% endif %}
    </section>
    <hr>
</main>

<main>
    <h2>Comments</h2>
    <div>
        <form action="{% url 'comment' listing.id %}" method="POST">
            {% csrf_token %}
            <input name="message" type="text" placeholder="Add comment...">
            <input type="submit" value="Comment">
        </form>
    </div>
    {% for comment in comments %}
        <div>
            <h5>
                <strong>
                    {{comment.commentator}}
                    {% if is_owner %} (owner) {% endif %}
                </strong>
                âˆ™
                {{ comment.time }}
                {% if comment.is_modified %} (edited) {% endif %}
            </h5>
            {% if request.user.id == comment.commentator.id %}
                <form action="{% url 'comment_edit' listing.id comment.id %}">
                    <input type="submit" value="Edit">
                </form>
            {% endif %}
            <p>{{ comment.message }}</p>
        </div>
    {% endfor %}
</main>
{% endblock body %}